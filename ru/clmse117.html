<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Opening and Closing Files</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-06-05 15:52:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
   <div id="toplinks"> &lt;<a href="../index.html">Главная</a>&gt; &lt;<a href="symbols.html">Символы</a>&gt; <br />&#x003C;<a 
href="clmse118.html" >Далее</a>&#x003E;&#x003C;<a 
href="clmse116.html" >Назад</a>&#x003E;&#x003C;<a 
href="clmse116.html#tailclmse116.html" >Назад-и-вниз</a>&#x003E;&#x003C;<a 
href="#tailclmse117.html">В-конец</a>&#x003E;&#x003C;<a 
href="files.html#clmse117.html" >Наверх</a>&#x003E;</div><h3 class="sectionHead"><span class="titlemark">23.2
</span> <a 
href="clm.html#QQ2-145-249" id="x145-21000023.2">Opening and Closing Files</a></h3>
<!--l. 1922--><p class="noindent" >When a ﬁle is <em>opened</em>, a stream object is constructed to serve as the ﬁle system&#x2019;s
ambassador to the Lisp environment; operations on the stream are reﬂected by
operations on the ﬁle in the ﬁle system. The act of <em>closing</em> the ﬁle (actually, the
stream) ends the association; the transaction with the ﬁle system is terminated,
and input/output may no longer be performed on the stream. The stream
function <b><a 
href="symbols.html#x188-375240r240">close</a></b> may be used to close a ﬁle; the functions described below may be
used to open them. The basic operation is <b><a 
href="symbols.html#x188-375689r689">open</a></b>, but <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> is usually
more convenient for most applications.
<div class="defun">
<div class="defunheader">
<em>
<!--l. 1934--><p class="noindent" >[Function]</em><a 
 id="dx145-210001"></a> <b>open</b> <i>ﬁlename</i> <tt><a 
href="clmse29.html#x39-620005.2.2">&#x0026;key</a></tt> <i>:direction</i> <i>:element-type</i> <i>:if-exists</i> <i>:if-does-not-exist</i>
<i>:external-format</i>
</div>
<div class="newer">
<!--l. 1937--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210002"></a>to add to the function <b><a 
href="symbols.html#x188-375689r689">open</a></b> a new keyword
argument <b>:external-format</b>. This argument did not appear in the preceding
argument description in the ﬁrst edition.
</div>
<!--l. 1943--><p class="indent" >   This returns a stream that is connected to the ﬁle speciﬁed by <em>ﬁlename</em>. The
<em>ﬁlename</em> is the name of the ﬁle to be opened; it may be a string, a pathname, or a
stream. (If the <em>ﬁlename</em> is a stream, then it is not closed ﬁrst or otherwise
aﬀected; it is used merely to provide a ﬁle name for the opening of a new
stream.)
<div class="new">
<!--l. 1950--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx145-210003"></a>to specify that the result of <b><a 
href="symbols.html#x188-375689r689">open</a></b>, if it is a
stream, is always a stream of type <b>ﬁle-stream</b>.
</div>
                                                                          

                                                                          
<div class="new">
<!--l. 1957--><p class="indent" >   X3J13 voted in March 1988 <a 
 id="dx145-210004"></a>to specify exactly which streams may be used as
pathnames. See section <a 
href="clmse116.html#x144-20900023.1.6">23.1.6<!--tex4ht:ref: PATHNAME-FUNCTIONS --></a>.
</div>
<div class="new">
<!--l. 1964--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx145-210005"></a>to specify that <b><a 
href="symbols.html#x188-375689r689">open</a></b> is unaﬀected by whether
the ﬁrst argument, if a stream, is open or closed. If the ﬁrst argument is a stream,
<b><a 
href="symbols.html#x188-375689r689">open</a></b> behaves as if the function <b><a 
href="symbols.html#x188-375706r706">pathname</a></b> were applied to the stream and the
resulting pathname used instead.
</div>
<div class="newer">
<!--l. 1973--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210006"></a>to clarify that <b><a 
href="symbols.html#x188-375689r689">open</a></b> accepts only non-wild
pathnames; an error is signaled if <b><a 
href="symbols.html#x188-375999r999">wild-pathname-p</a></b> would be true of
<em>ﬁlename</em>.
</div>
<div class="newer">
<!--l. 1979--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210007"></a>to require <b><a 
href="symbols.html#x188-375689r689">open</a></b> to accept logical pathnames (see
section <a 
href="clmse116.html#x144-20300023.1.5">23.1.5<!--tex4ht:ref: LOGICAL-PATHNAMES-SECTION --></a>).
</div>
<!--l. 1983--><p class="indent" >   The keyword arguments specify what kind of stream to produce and how to
handle errors: <div class="flushdesc">
      <ul><li><b>
<b>:direction</b> </b></li>This argument speciﬁes whether the stream should handle input,
      output, or both.
              <div class="quotation">
<div class="flushdesc">
    <ul><li><b>
<b>:input</b> </b></li>The  result  will  be  an  input  stream.  This  is  the
    default.
    <li><b>
<b>:output</b> </b></li>The result will be an output stream.
    <li><b>
<b>:io</b> </b></li>The result will be a bidirectional stream.
                                                                          

                                                                          
    <li><b>
<b>:probe</b> </b></li>The result will be a no-directional stream (in eﬀect,
    the stream is created and then closed). This is useful for
    determining whether a ﬁle exists without actually setting
    up a complete stream.</ul>
</div>
           </div>
      <li><b>
<b>:element-type</b> </b></li>This argument speciﬁes the type of the unit of transaction for the
      stream. Anything that can be recognized as being a ﬁnite subtype of
      <b><a 
href="symbols.html#x188-375222r222">character</a></b> or <b>integer</b> is acceptable. In particular, the following types are
      recognized:
      <!--l. 2013--><p class="noindent" >
              <div class="quotation">
<div class="flushdesc">
    <ul><li><b>
<b><a 
href="symbols.html#x188-375222r222">character</a></b> </b></li>The  unit  of  transaction  is  any  character,  not
    just  a  string-character.  The  functions  <b><a 
href="symbols.html#x188-375768r768">read-char</a></b> and
    <b><a 
href="symbols.html#x188-376015r1015">write-char</a></b> (depending on the value of the <b>:direction</b>
    argument)  may  be  used  on  the  stream.  This  is  the
    default.
    <li><b>
<b>base-char</b> </b></li>The unit of transaction is a base character. The
    functions <b><a 
href="symbols.html#x188-375768r768">read-char</a></b> and <b><a 
href="symbols.html#x188-376015r1015">write-char</a></b> (depending on the
    value of the <b>:direction</b> argument) may be used on the
    stream.</ul>
</div>
           </div>
      <!--l. 2027--><p class="noindent" >
              <div class="quotation">
<div class="flushdesc">
                                                                          

                                                                          
    <ul><li><b>
<b>(unsigned-byte <em>n</em>)</b> </b></li>The unit of transaction is an unsigned
    byte (a non-negative integer) of size <em>n</em>. The functions
    <b><a 
href="symbols.html#x188-375767r767">read-byte</a></b>  and/or  <b><a 
href="symbols.html#x188-376014r1014">write-byte</a></b>  may  be  used  on  the
    stream.
    <li><b>
<b>unsigned-byte</b> </b></li>The  unit  of  transaction  is  an  unsigned
    byte  (a  non-negative  integer);  the  size  of  the  byte  is
    determined by the ﬁle system. The functions <b><a 
href="symbols.html#x188-375767r767">read-byte</a></b>
    and/or <b><a 
href="symbols.html#x188-376014r1014">write-byte</a></b> may be used on the stream.
    <li><b>
<b>(signed-byte <em>n</em>)</b> </b></li>The unit of transaction is a signed byte
    of size <em>n</em>. The functions <b><a 
href="symbols.html#x188-375767r767">read-byte</a></b> and/or <b><a 
href="symbols.html#x188-376014r1014">write-byte</a></b>
    may be used on the stream.
    <li><b>
<b>signed-byte</b> </b></li>The unit of transaction is a signed byte; the
    size of the byte is determined by the ﬁle system. The
    functions <b><a 
href="symbols.html#x188-375767r767">read-byte</a></b> and/or <b><a 
href="symbols.html#x188-376014r1014">write-byte</a></b> may be used
    on the stream.
    <li><b>
<b><a 
href="symbols.html#x188-375123r123">bit</a></b> </b></li>The unit of transaction is a bit (values <b>0</b> and <b>1</b>). The
    functions <b><a 
href="symbols.html#x188-375767r767">read-byte</a></b> and/or <b><a 
href="symbols.html#x188-376014r1014">write-byte</a></b> may be used
    on the stream.
    <li><b>
<b>(mod <em>n</em>)</b> </b></li>The   unit   of   transaction   is   a   non-negative
    integer  less  than  <em>n</em>.  The  functions  <b><a 
href="symbols.html#x188-375767r767">read-byte</a></b> and/or
    <b><a 
href="symbols.html#x188-376014r1014">write-byte</a></b> may be used on the stream.
    <li><b>
<b>:default</b> </b></li>The  unit  of  transaction  is  to  be  determined
    by   the   ﬁle   system,   based   on   the   ﬁle   it   ﬁnds.
    The  type  can  be  determined  by  using  the  function
    <b><a 
href="symbols.html#x188-375891r891">stream-element-type</a></b>.</ul>
</div>
           </div>
      <li><b>
                                                                          

                                                                          
<b>:if-exists</b> </b></li>This argument speciﬁes the action to be taken if the <b>:direction</b> is
      <b>:output</b> or <b>:io</b> and a ﬁle of the speciﬁed name already exists. If the
      direction is <b>:input</b> or <b>:probe</b>, this argument is ignored.
              <div class="quotation">
<div class="flushdesc">
    <ul><li><b>
<b>:error</b> </b></li>Signals an error. This is the default when the version
    component of the <em>ﬁlename</em> is not <b>:newest</b>.
    <li><b>
<b>:new-version</b> </b></li>Creates a new ﬁle with the same ﬁle name but
    with a larger version number. This is the default when
    the version component of the <em>ﬁlename</em> is <b>:newest</b>.
    <li><b>
<b>:rename</b> </b></li>Renames the existing ﬁle to some other name and
    then creates a new ﬁle with the speciﬁed name.
    <li><b>
<b>:rename-and-delete</b> </b></li>Renames  the  existing  ﬁle  to  some
    other name and then deletes it (but does not expunge
    it,  on  those  systems  that  distinguish  deletion  from
    expunging). Then create a new ﬁle with the speciﬁed
    name.
    <li><b>
<b>:overwrite</b> </b></li>Uses  the  existing  ﬁle.  Output  operations  on
    the  stream  will  destructively  modify  the  ﬁle.  If  the
    <b>:direction</b> is <b>:io</b>, the ﬁle is opened in a bidirectional
    mode  that  allows  both  reading  and  writing.  The  ﬁle
    pointer is initially positioned at the beginning of the ﬁle;
    however, the ﬁle is not truncated back to length zero
    when it is opened. This mode is most useful when the
    <b><a 
href="symbols.html#x188-375394r394">ﬁle-position</a></b> function can be used on the stream.
    <li><b>
<b>:append</b> </b></li>Uses the existing ﬁle. Output operations on the
    stream will destructively modify the ﬁle. The ﬁle pointer
    is  initially  positioned  at  the  end  of  the  ﬁle.  If  the
                                                                          

                                                                          
    <b>:direction</b> is <b>:io</b>, the ﬁle is opened in a bidirectional
    mode that allows both reading and writing.
    <li><b>
<b>:supersede</b> </b></li>Supersedes  the  existing  ﬁle.  If  possible,  the
    implementation should arrange not to destroy the old ﬁle
    until the new stream is closed, against the possibility that
    the stream will be closed in “abort”  mode (see <b><a 
href="symbols.html#x188-375240r240">close</a></b>).
    This  diﬀers  from  <b>:new-version</b>  in  that  <b>:supersede</b>
    creates a new ﬁle with the same name as the old one,
    rather than a ﬁle name with a higher version number.
    <li><b>
<b><b><a 
href="symbols.html#x188-375658r658">nil</a></b></b> </b></li>Does not create a ﬁle or even a stream, but instead simply
    returns <b><a 
href="symbols.html#x188-375658r658">nil</a></b> to indicate failure.</ul>
</div>
           </div>
      <!--l. 2125--><p class="noindent" >If the <b>:direction</b> is <b>:output</b> or <b>:io</b> and the value of <b>:if-exists</b> is
      <b>:new-version</b>, then the version of the (newly created) ﬁle that is
      opened will be a version greater than that of any other ﬁle in the ﬁle
      system whose other pathname components are the same as those of
      <em>ﬁlename</em>.
      <!--l. 2131--><p class="noindent" >If the <b>:direction</b> is <b>:input</b> or <b>:probe</b> or the value of <b>:if-exists</b> is not
      <b>:new-version</b>, <em>and</em> the version component of the <em>ﬁlename</em> is <b>:newest</b>,
      then the ﬁle opened is that ﬁle already existing in the ﬁle system
      that has a version greater than that of any other ﬁle in the ﬁle
      system whose other pathname components are the same as those of
      <em>ﬁlename</em>.
<div class="new">
      <!--l. 2139--><p class="noindent" >Some ﬁle systems permit yet other actions to be taken when a ﬁle already
      exists; therefore, some implementations provide implementation-speciﬁc
      <b>:if-exist</b> options.
      </div></ul>
</div>__________________________________________________________________________<div class="implementation">
<!--l. 2146--><p class="noindent" ><b>Заметка для реализации:</b> The various ﬁle systems in existence today have widely
diﬀering capabilities. A given implementation may not be able to support all of these
options in exactly the manner stated. An implementation is required to recognize all of
these option keywords and to try to do something “reasonable” in the context of the host
                                                                          

                                                                          
operating system. Implementors are encouraged to approximate the semantics speciﬁed
here as closely as possible.
<!--l. 2155--><p class="indent" >   As an example, suppose that a ﬁle system does not support distinct ﬁle versions and
does not distinguish the notions of deletion and expunging (in some ﬁle systems ﬁle
deletion is reversible until an expunge operation is performed). Then <b>:new-version</b>
might be treated the same as <b>:rename</b> or <b>:supersede</b>, and <b>:rename-and-delete</b> might
be treated the same as <b>:supersede</b>.
<!--l. 2162--><p class="indent" >   If it is utterly impossible for an implementation to handle some option in a manner
close to what is speciﬁed here, it may simply signal an error. The opening of ﬁles is an
area where complete portability is too much to hope for; the intent here is simply to
make things as portable as possible by providing speciﬁc names for a range of commonly
supportable options.
</div>
__________________________________________________________________________
<div class="flushdesc">
        <ul><li><b>
<b>:if-does-not-exist</b> </b></li>This argument speciﬁes the action to be taken if a ﬁle of the
        speciﬁed name does not already exist.
                   <div class="quotation">
<div class="flushdesc">
      <ul><li><b>
<b>:error</b> </b></li>Signals an error. This is the default if the <b>:direction</b>
     is <b>:input</b>, or if the <b>:if-exists</b> argument is <b>:overwrite</b> or
      <b>:append</b>.
      <li><b>
<b>:create</b> </b></li>Creates an empty ﬁle with the speciﬁed name and
      then  proceeds  as  if  it  had  already  existed  (but  do
      not perform any processing directed by the <b>:if-exists</b>
     argument).  This  is  the  default  if  the  <b>:direction</b>  is
      <b>:output</b> or <b>:io</b>, and the <b>:if-exists</b> argument is anything
      but <b>:overwrite</b> or <b>:append</b>.
      <li><b>
<b><b><a 
href="symbols.html#x188-375658r658">nil</a></b></b> </b></li>Does not create a ﬁle or even a stream, but instead simply
      returns <b><a 
href="symbols.html#x188-375658r658">nil</a></b> to indicate failure. This is the default if the
      <b>:direction</b> is <b>:probe</b>.</ul>
                                                                          

                                                                          
</div>
           </div>
      </ul>
</div>
<div class="newer">
<!--l. 2197--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210008"></a>to add to the function <b><a 
href="symbols.html#x188-375689r689">open</a></b> a new keyword
argument <b>:external-format</b>. <div class="flushdesc">
      <ul><li><b>
<b>:external-format</b> </b></li>This  argument  speciﬁes  an  implementation-recognized
      scheme for representing characters in ﬁles. The default value is <b>:default</b>
      and is implementation-deﬁned but must support the base characters.
      An error is signaled if the implementation does recognize the speciﬁed
      format.
      <!--l. 2206--><p class="noindent" >This argument may be speciﬁed if the <b>:direction</b> argument is <b>:input</b>,
      <b>:output</b>, or <b>:io</b>. It is an error to write a character to the resulting
      stream  that  cannot  be  represented  by  the  speciﬁed  ﬁle  format.
      (However, the <b>#\Newline</b> character cannot produce such an error;
      implementations must provide appropriate line division behavior for all
      character streams.)
      <!--l. 2213--><p class="noindent" >See <b><a 
href="symbols.html#x188-375894r894">stream-external-format</a></b>.</ul>
</div>
</div>
<!--l. 2217--><p class="indent" >   When the caller is ﬁnished with the stream, it should close the ﬁle by using
the <b><a 
href="symbols.html#x188-375240r240">close</a></b> function. The <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> form does this automatically,
and so is preferred for most purposes. <b><a 
href="symbols.html#x188-375689r689">open</a></b> should be used only when
the control structure of the program necessitates opening and closing of
a ﬁle in some way more complex than provided by <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b>. It
is suggested that any program that uses <b><a 
href="symbols.html#x188-375689r689">open</a></b> directly should use the
special operator <b><a 
href="symbols.html#x188-375976r976">unwind-protect</a></b> to close the ﬁle if an abnormal exit
occurs.
<hr></div>
<div class="defmac">
<div class="defmacheader">
<!--l. 2228--><p class="indent" >   <div class="tabbing">
                                                                          

                                                                          
 <em>[Макрос]</em> <b>with-open-ﬁle</b> <a 
 id="dx145-210009"></a>(stream ﬁlename {options}*){declaration}* {form}*
   <br>
<!--l. 2230--><p class="noindent" ></div>
</div>
<b>
<!--l. 2231--><p class="indent" >   <a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> evaluates the <em>forms</em> of the body (an implicit <b><a 
href="symbols.html#x188-375749r749">progn</a></b>) with the
variable <em>stream</em> bound to a stream that reads or writes the ﬁle named by the value
of <em>ﬁlename</em>. The <em>options</em> are evaluated and are used as keyword arguments to the
function <b><a 
href="symbols.html#x188-375689r689">open</a></b>.
<!--l. 2238--><p class="indent" >   When control leaves the body, either normally or abnormally (such as by use
of <b>throw</b>), the ﬁle is automatically closed. If a new output ﬁle is being written,
and control leaves abnormally, the ﬁle is aborted and the ﬁle system is left, so far
as possible, as if the ﬁle had never been opened. Because <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> always
closes the ﬁle, even when an error exit is taken, it is preferred over <b><a 
href="symbols.html#x188-375689r689">open</a></b> for most
applications.
<em>
<!--l. 2246--><p class="indent" >   ﬁlename</em> is the name of the ﬁle to be opened; it may be a string, a pathname,
or a stream.
<div class="new">
<!--l. 2250--><p class="indent" >   X3J13 voted in March 1988 <a 
 id="dx145-210010"></a>to specify exactly which streams may be used as
pathnames. See section <a 
href="clmse116.html#x144-20900023.1.6">23.1.6<!--tex4ht:ref: PATHNAME-FUNCTIONS --></a>.
</div>
<div class="newer">
<!--l. 2257--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210011"></a>to clarify that <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> accepts only
non-wild pathnames; an error is signaled if <b><a 
href="symbols.html#x188-375999r999">wild-pathname-p</a></b> would be true of
the <em>ﬁlename</em> argument.
</div>
<div class="newer">
<!--l. 2264--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210012"></a>to require <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> to accept logical
pathnames (see section <a 
href="clmse116.html#x144-20300023.1.5">23.1.5<!--tex4ht:ref: LOGICAL-PATHNAMES-SECTION --></a>).
</div>
<!--l. 2269--><p class="indent" >   For example: <div class="lisp"><tt><div class="tabbing">
(with-open-ﬁle (iﬁle name
   <br>                                                               :direction :input)<br>
  (with-open-ﬁle (oﬁle (merge-pathname-defaults iﬁle<br>
                                                                          

                                                                          
                                                  nil<br>
                                                  &#x0022;out&#x0022;)<br>
                         :direction :output<br>
                         :if-exists :supersede)<br>
    (transduce-ﬁle iﬁle oﬁle)))<br>
<!--l. 2279--><p class="noindent" ></div>
</tt>
</div>
<div class="newer">
<!--l. 2282--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx145-210013"></a>to specify that the variable <em>stream</em> is not always
bound to a stream; rather it is bound to whatever would be returned by a call to
<b><a 
href="symbols.html#x188-375689r689">open</a></b>. For example, if the options include <b>:if-does-not-exist nil</b>, <em>stream</em> will be
bound to <b><a 
href="symbols.html#x188-375658r658">nil</a></b> if the ﬁle does not exist. In this case the value of <em>stream</em> should be
tested within the body of the <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> form before it is used as a stream.
For example: <div class="lisp"><tt><div class="tabbing">
(with-open-ﬁle (iﬁle name
   <br>                                                                :direction :input<br>
                 :if-does-not-exist nil)<br>
  ;; Process the ﬁle only if it actually exists.<br>        (when (streamp name)<br>
    (compile-cobol-program iﬁle)))<br>
<!--l. 2297--><p class="noindent" ></div>
</tt>
</div>
</div>
<hr>
</div>__________________________________________________________________________<div class="implementation">
<!--l. 2302--><p class="noindent" ><b>Заметка для реализации:</b> While <b><a 
href="symbols.html#x188-376006r1006">with-open-ﬁle</a></b> tries to automatically close the
stream on exit from the construct, for robustness it is helpful if the garbage collector can
detect discarded streams and automatically close them.
</div>___________________________________________________________________________________________________________
                                                                          

                                                                          
<!--l. 2310--><p class="indent" >   <div id="bottomlinks">&#x003C;<a 
href="clmse118.html" >Далее</a>&#x003E;&#x003C;<a 
href="clmse116.html" >Назад</a>&#x003E;&#x003C;<a 
href="clmse116.html#tailclmse116.html" >Назад-и-вниз</a>&#x003E;&#x003C;<a 
href="clmse117.html" >В-начало</a>&#x003E;&#x003C;<a 
href="files.html#clmse117.html" >Наверх</a>&#x003E;<br> &lt;<a href="../index.html">Главная</a>&gt; &lt;<a href="symbols.html">Символы</a>&gt;</div><a 
 id="tailclmse117.html"></a>
 
</body></html> 
