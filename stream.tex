%Part{Stream, Root = "CLM.MSS"}
%%%Chapter of Common Lisp Manual.  Copyright 1984, 1988, 1989 Guy L. Steele Jr.

\clearpage\def\pagestatus{FINAL PROOF}

\ifx \rulang\Undef

\chapter{Streams}
\label{STREAM}

Streams are objects that serve as sources or sinks of data.
Character streams produce or absorb characters;
binary streams produce or absorb integers.
The normal action of a Common Lisp system is to read characters from
a character input stream, parse the characters as representations
of Common Lisp data objects, evaluate each object (as a form) as it is read, and
print representations of the results of
evaluation to an output character stream.

Typically streams are connected to files or to an interactive terminal.
Streams, being Lisp objects, serve as the ambassadors of external
devices by which input/output is accomplished.

A stream, whether a character stream or a binary
stream, may be input-only, output-only, or bidirectional.
What operations may be performed on a stream depends on which of
the six types of stream it is.

\section {Standard Streams}

There are several variables whose values are streams used by many
functions in the Lisp system.  These variables and their uses are
listed here.  By convention, variables that are expected to hold a
stream capable of input have names ending with \cdf{-input}, and
variables that are expected to hold a
stream capable of output have names ending with \cdf{-output}.
Variables expected to hold a
bidirectional stream have names ending with \cdf{-io}.

\begin{defun}[Variable]
*standard-input*

In the normal Lisp top-level loop, input is read from
\cdf{*standard-input*} (that is, whatever stream is the value of the global
variable \cdf{*standard-input*}).  Many input functions, including
\cdf{read} and \cdf{read-char}, take a stream argument that defaults to
\cdf{*standard-input*}.
\end{defun}

\begin{defun}[Variable]
*standard-output*

In the normal Lisp top-level loop, output is sent to
\cdf{*standard-output*} (that is, whatever stream is the value of the global
variable \cdf{*standard-output*}).  Many output functions, including
\cdf{print} and \cdf{write-char}, take a stream argument that defaults
to \cdf{*standard-output*}.
\end{defun}

\begin{defun}[Variable]
*error-output*

The value of \cdf{*error-output*} is a stream to which error messages
should be sent.  Normally this is the same as \cdf{*standard-output*},
but \cdf{*standard-output*} might be bound to a file and \cdf{*error-output*}
left going to the terminal or to a separate file of error messages.
\end{defun}

\begin{defun}[Variable]
*query-io*

The value of \cdf{*query-io*} is a stream to be used when
asking questions of the user.  The question should be output to this
stream, and the answer read from it.  When
the normal input to a program may be coming from a file, questions such
as ``Do you really want to delete all of the files in your directory?'' should
nevertheless
be sent directly to the user; and the answer should come from the user,
not from the data file.  For such purposes \cdf{*query-io*} should be
used instead of \cdf{*standard-input*} and \cdf{*standard-output*}.
\cdf{*query-io*} is used by such functions
as \cdf{yes-or-no-p}.
\end{defun}

\begin{defun}[Variable]
*debug-io*

The value of \cdf{*debug-io*} is a stream to be used for interactive
debugging purposes.  This is often the same as the value of \cdf{*query-io*},
but need not be.
\end{defun}

\begin{defun}[Variable]
*terminal-io*

The value of \cdf{*terminal-io*} is ordinarily
the stream that connects to the user's console.
Typically, writing to this stream would cause the output to appear
on a display screen, for example, and reading from the stream would
accept input from a keyboard.

It is intended
that standard input functions such as \cdf{read} and \cdf{read-char},
when used with this stream, would cause ``echoing'' of the input
into the output side of the stream.  (The means by which this is
accomplished are of course highly implementation-dependent.)
\end{defun}

\begin{defun}[Variable]
*trace-output*

The value of \cdf{*trace-output*} is the stream on which the \cdf{trace}
function prints its output.
\end{defun}

The variables
\cdf{*standard-input*}, \cdf{*standard-output*},
\cdf{*error-output*},
\cdf{*trace-output*},
\cdf{*query-io*}, and \cdf{*debug-io*}
are initially bound to synonym streams that pass all
operations on to the stream that is the value of \cdf{*terminal-io*}.
(See \cdf{make-synonym-stream}.)
Thus any operations performed on those streams will go to the terminal.

\begin{new}
X3J13 voted in January 1989
\issue{STANDARD-INPUT-INITIAL-BINDING}
to replace the requirements of the preceding
paragraph with the following new requirements:

The seven standard stream variables,
\cdf{*standard-input*}, \cdf{*standard-output*}, \cdf{*query-io*},
\cdf{*debug-io*}, \cdf{*terminal-io*},
\cdf{*error-output*}, and
\cdf{*trace-output*},
are initially bound to open streams.  (These will be called
\emph{the standard initial streams}.)

The streams that are the initial values of
\cdf{*standard-input*}, \cdf{*query-io*}, \cdf{*debug-io*}, and \cdf{*terminal-io*}
must support input.

The streams that are the initial values of
\cdf{*standard-output*},
\cdf{*error-output*},
\cdf{*trace-output*}, \cdf{*query-io*}, \cdf{*debug-io*}, and \cdf{*terminal-io*}
must support output.

None of the standard initial streams (including the one to which
\cdf{*terminal-io*} is initially bound) may be a synonym, either directly
or indirectly, for any of the standard stream variables
except \cdf{*terminal-io*}.  For example, the initial value of
\cdf{*trace-output*} may be a synonym stream for \cdf{*terminal-io*}
but not a synonym stream for \cdf{*standard-output*} or \cdf{*query-io*}.
(These are examples of direct synonyms.)  As another example,
\cdf{*query-io*} may be a two-way stream or echo stream whose
input component is a synonym for \cdf{*terminal-io*},
but its input component may not be a synonym for \cdf{*standard-input*}
or \cdf{*debug-io*}.  (These are examples of indirect synonyms.)

Any or all of the standard initial streams may be direct or indirect
synonyms for one or more common implementation-dependent streams.
For example, the standard initial streams might all be synonym streams
(or two-way or echo streams whose components are synonym streams)
to a pair of hidden terminal input and output streams maintained by
the implementation.

Part of the intent of these rules is to ensure that it is always safe
to bind any standard stream variable to the value of any other
standard stream variable (that is, unworkable circularities are
avoided) without unduly restricting implementation flexibility.
\end{new}

No user program should ever change the value of \cdf{*terminal-io*}.  A program
that wants (for example) to divert output to a file should do so by binding
the value of \cdf{*standard-output*}; that way error messages sent to
\cdf{*error-output*} can still get to the user by going through \cdf{*terminal-io*},
which is usually what is desired.

\section {Creating New Streams}

Perhaps the most important constructs for creating new streams
are those that open files; see \cdf{with-open-file} and \cdf{open}.
The following functions construct streams without reference to a file system.

\begin{defun}[Function]
make-synonym-stream symbol

\cdf{make-synonym-stream} creates and returns
a synonym stream.
Any operations on the new stream will be performed on the stream
that is then the value of the dynamic variable named by the \emph{symbol}.
If the value of the variable should change or be bound,
then the synonym stream will operate on the new stream.

The result of
\cdf{make-synonym-stream} is always a stream of type \cdf{synonym-stream}.
Note that the type of a synonym stream is \emph{always} \cdf{synonym-stream},
regardless of the type of the stream for which it is a synonym.
\end{defun}

\begin{defun}[Function]
make-broadcast-stream &rest streams

This returns a stream that works only in the output direction.  Any output
sent to this stream will be sent to all of the \emph{streams} given.
The set of
operations that may be performed on the new stream is the intersection
of those for the given streams.  The results returned by a stream
operation are the values resulting from
performing the operation on the last stream in \emph{streams}; the
results of performing the operation on all preceding streams are
discarded.
If no \emph{streams} are given as arguments, then the result
is a ``bit sink''; all output to the resulting stream is discarded.
The result of
\cd{make-broadcast-stream} is always a stream of type \cdf{broadcast-stream}.
\end{defun}

\begin{defun}[Function]
make-concatenated-stream &rest streams

This returns a stream that works only in the input direction.
Input is taken from the first of the \emph{streams} until it reaches
end-of-file; then that stream is discarded, and input is taken
from the next of the \emph{streams}, and so on.  If no arguments
are given, the result is a stream with no content; any input attempt
will result in end-of-file.
The result of
\cd{make-concatenated-stream} is always a stream of type \cdf{concatenated-stream}.
\end{defun}

\begin{defun}[Function]
make-two-way-stream input-stream output-stream

This returns a bidirectional stream that gets its input from \emph{input-stream}
and sends its output to \emph{output-stream}.
The result of
\cd{make-two-way-stream} is always a stream of type \cdf{two-way-stream}.
\end{defun}

\begin{defun}[Function]
make-echo-stream input-stream output-stream

This returns a bidirectional stream that gets its input from \emph{input-stream}
and sends its output to \emph{output-stream}.  In addition, all
input taken from \emph{input-stream} is echoed to \emph{output-stream}.

Result of
\cd{make-echo-stream} is always a stream of type \cdf{echo-stream}.

\begin{new}
X3J13 voted in January 1989
\issue{PEEK-CHAR-READ-CHAR-ECHO}
to clarify the interaction of
\cdf{read-char}, \cdf{unread-char}, and \cdf{peek-char} with echo streams.
(See the descriptions of those functions for details.)

X3J13 explicitly noted that the bidirectional streams that are the initial
values of \cdf{*query-io*}, \cdf{*debug-io*}, and \cdf{*terminal-io*},
even though they may have some echoing behavior, conceptually
are not necessarily the products of calls to \cdf{make-echo-stream}
and therefore are not subject to the new rules about echoing on echo
streams.  Instead, these initial interactive streams may have
implementation-dependent echoing behavior.
\end{new}
\end{defun}

\begin{defun}[Function]
make-string-input-stream string &optional start end

This returns an input stream.
The input stream will supply, in order, the characters in the substring
of \emph{string} delimited by \emph{start} and \emph{end}; after the last
character has been supplied, the stream will then be at end-of-file.

Result of
\cdf{make-string-input-stream} is always a stream of type \cdf{string-stream}.
\end{defun}

\begin{defun}[Function]
make-string-output-stream &key :element-type

This returns an output stream that will 
accumulate all output given it for the benefit of the function
\cdf{get-output-stream-string}.

The \cd{:element-type} argument specifies what characters
must be accepted by the created stream.  If the \cd{:element-type} argument
is omitted, the created stream must accept all characters.

The result of
\cdf{make-string-output-stream} is always a stream of type \cdf{string-stream}.
\end{defun}

\begin{defun}[Function]
get-output-stream-string string-output-stream

Given a stream produced by \cdf{make-string-output-stream}, this
returns a string containing all the characters output to the stream so far.
The stream is then reset; thus each call to \cdf{get-output-stream-string}
gets only the characters since the last such call (or the creation
of the stream, if no such previous call has been made).
\end{defun}

\begin{defmac}
with-open-stream (var stream) {declaration}* {form}*

The form \emph{stream} is evaluated and must produce a stream.
The variable \emph{var} is bound with the stream as its value,
and then the forms of the body are executed
as an implicit \cdf{progn}; the results of evaluating
the last form are returned as the value of the \cdf{with-open-stream} form.
The stream
is automatically closed on exit from the \cdf{with-open-stream} form,
no matter whether the exit is normal or abnormal;
see \cdf{close}.
The stream should be regarded as having dynamic extent.

The stream created by
\cdf{with-open-stream} is always of type \cdf{file-stream}.
\end{defmac}

\begin{defmac}
with-input-from-string (var string {keyword value}*)
      {declaration}* {form}*

The body is executed as an implicit \cdf{progn} with the variable \emph{var}
bound to a character input stream that supplies successive characters from
the value of the form \emph{string}.  \cdf{with-input-from-string}
returns the results from the last \emph{form} of the body.

The input stream is automatically closed on exit from
the \cd{with-input-from-string} form,
no matter whether the exit is normal or abnormal.
The stream should be regarded as having dynamic extent.

The stream created by
\cdf{with-input-from-string} is always of type \cdf{string-stream}.

The following keyword options may be used:
\begin{quotation}
\begin{flushdesc}
\item[\cd{:index}]
The form after the \cd{:index} keyword should be a \emph{place}
acceptable to \cdf{setf}.  If the \cdf{with-input-from-string} form
is exited normally, then the \emph{place} will have stored into it the
index into the \emph{string} indicating the first character not read
(the length of the string if all characters were used).
The \emph{place} is not updated as reading progresses, but only at the
end of the operation. 

\item[\cd{:start}]
The \cd{:start} keyword takes an argument indicating, in the manner
usual for sequence functions, the beginning of
a substring of \emph{string} to be used.

\item[\cd{:end}]
The \cd{:end} keyword takes an argument indicating, in the manner
usual for sequence functions, the end of
a substring of \emph{string} to be used.
\end{flushdesc}
\end{quotation}

Here is an example of the use of \cdf{with-input-from-string}:
\begin{lisp}
(with-input-from-string (s "Animal Crackers" :index j :start 6) \\
~~(read s)) \EV\ crackers
\end{lisp}
As a side effect, the variable \cdf{j} is set to \cd{15}.

\begin{new}
X3J13 voted in January 1989
\issue{MAPPING-DESTRUCTIVE-INTERACTION}
to restrict user side effects; see section \ref{STRUCTURE-TRAVERSAL-SECTION}.
\end{new}
\end{defmac}

\begin{defmac}
with-output-to-string (var [string [\!:element-type! type]])
                      {declaration}* {form}*

One may specify \cdf{nil} instead of a string as the \emph{string}
and use the \cd{:element-type} argument to specify what characters
must be accepted by the created stream.  If no \emph{string} argument
is provided, or if it is \cdf{nil} and no \cd{:element-type} is specified,
the created stream must accept all characters.

If \emph{string} is specified, it must be a string with a fill pointer;
the output is incrementally appended to the string (as if by use of
\cdf{vector-push-extend}).

In this way output cannot be accidentally lost.  This change makes
\cd{with-output-to-string} behave in the same way that \cdf{format} does
when given a string as its first argument.

The stream created by
\cdf{with-output-to-string} is always of type \cdf{string-stream}.

X3J13 voted in January 1989
\issue{MAPPING-DESTRUCTIVE-INTERACTION}
to restrict user side effects; see section \ref{STRUCTURE-TRAVERSAL-SECTION}.
\end{defmac}

\section {Operations on Streams}

This section contains discussion of only those operations that
are common to all streams.  Input and output is rather complicated
and is discussed separately in chapter~\ref{IO}.
The interface between streams and the file system is discussed
in chapter~\ref{FILES}.

\begin{defun}[Function]
streamp object

\cdf{streamp} is true if its argument is a stream,
and otherwise is false.
\begin{lisp}
(streamp x) \EQ\ (typep x 'stream)
\end{lisp}

\cdf{streamp} is unaffected
by whether its argument, if a stream, is open or closed.  In either case
it returns true.
\end{defun}

\begin{defun}[Function]
open-stream-p stream

X3J13 voted in January 1989 \issue{STREAM-ACCESS}
to add the predicate \cdf{open-stream-p}.
It is true if its argument (which must be a stream)
is open, and otherwise is false.

A stream is always created open; it remains open until closed
with the \cdf{close} function.  The macros \cdf{with-open-stream},
\cdf{with-input-from-string}, \cdf{with-output-to-string},
and \cdf{with-open-file} automatically close the created stream
as control leaves their bodies, in effect imposing dynamic extent
on the openness of the stream.
\end{defun}

\begin{defun}[Function]
input-stream-p stream

This predicate is true if its argument (which must be a stream) can handle
input operations, and otherwise is false.
\end{defun}

\begin{defun}[Function]
output-stream-p stream

This predicate is true if its argument (which must be a stream) can handle
output operations, and otherwise is false.
\end{defun}

\begin{defun}[Function]
stream-element-type stream

A type specifier is returned to indicate what objects
may be read from or written to the argument \emph{stream}, which must be a stream.
Streams created by \cdf{open} will have an element type
restricted to a subset of \cdf{character} or \cdf{integer},
but in principle a stream may conduct transactions using any
Lisp objects.
\end{defun}

\begin{defun}[Function]
close stream &key :abort

The argument must be a stream.
The stream is closed.  No further input/output operations may be performed
on it.  However, certain inquiry operations may still be performed,
and it is permissible to close an already closed stream.

\begin{newer}
X3J13 voted in January 1989
\issue{CLOSED-STREAM-OPERATIONS}
and revised the vote in March 1989
to specify that if \cdf{close} is called
on an open stream, the stream is closed and \cdf{t} is returned;
but if \cdf{close} is called on a closed stream, it succeeds without
error and returns an unspecified value.
(The rationale for not specifying the value returned for a closed stream
is that in some implementations closing certain streams does not really
have an effect on them---for example, closing the \cdf{*terminal-io*}
stream might not ``really'' close it---and it is not desirable to force
such implementations to keep otherwise unnecessary state.  Portable programs
will of course not rely on such behavior.)


X3J13 also voted in January 1989 to specify exactly which inquiry
functions may be applied to closed streams:
\begin{tabbing}
\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}}lll@{}}
\cdf{streamp} & \cdf{pathname-host} & \cdf{namestring} \\
\cdf{pathname} & \cdf{pathname-device} & \cdf{file-namestring} \\
\cdf{truename} & \cdf{pathname-directory} & \cdf{directory-namestring} \\
\cdf{merge-pathnames} & \cdf{pathname-name} & \cdf{host-namestring} \\
\cdf{open} & \cdf{pathname-type} & \cdf{enough-namestring} \\
\cdf{probe-file} & \cdf{pathname-version} & \cdf{directory} \\
\end{tabular*}
\end{tabbing}
See the individual descriptions of these functions for more information
on how they operate on closed streams.
\end{newer}

\begin{new}
X3J13 voted in January 1989
\issue{CLOSE-CONSTRUCTED-STREAM}
to clarify the effect of closing various
kinds of streams.  First some terminology:
\begin{itemize}
\item
A \emph{composite} stream is one that was returned by a call to
\cd{make-synonym-stream},
\cdf{make-broadcast-stream},
\cdf{make-concatenated-stream},
\cd{make-two-way-stream},
or \cd{make-echo-stream}.

\item
The \emph{constituents} of a composite stream are the streams that were given
as arguments to the function that constructed it or, in the case of
\cd{make-synonym-stream}, the stream that is the \cdf{symbol-value} of
the symbol that was given as an argument.  (The constituent of
a synonym stream may therefore vary over time.)

\item
A \emph{constructed} stream is either a composite stream or one returned
by a call to \cdf{make-string-input-stream}, \cdf{make-string-output-stream},
\cd{with-input-from-string}, or
\cdf{with-output-to-string}.
\end{itemize}

The effect of applying \cdf{close} to a constructed stream is to close
that stream only.  No input/output operations are permitted on the
constructed stream once it has been closed (though certain inquiry
functions are still permitted, as described above).

Closing a composite stream has no effect on its constituents;
any constituents that are open remain open.

If a stream created by \cdf{make-string-output-stream} is closed,
the result of then applying \cdf{get-output-stream-string} to the
stream is unspecified.
\end{new}

If the \cd{:abort} parameter is not {\false} (it defaults to {\false}), it
indicates an abnormal termination of the use of the stream.  An attempt
is made to clean up any side effects of having created the stream in the
first place.  For example, if the stream performs output to a file
that was newly created when the stream was created, then if possible the
file is deleted and any previously existing file is not superseded.
\end{defun}

\begin{defun}[Function]
broadcast-stream-streams broadcast-stream

The argument must be of type \cdf{broadcast-stream}.
A list of the constituent output streams (whether open or not) is returned.
\end{defun}


\begin{defun}[Function]
concatenated-stream-streams concatenated-stream

The argument must be of type \cdf{concatenated-stream}.
A list of constituent streams (whether open or not) is returned.
This list represents the ordered set of input streams from which
the concatenated stream may yet read; the stream from which it is
currently reading is first in the list.  The list may be empty
if no more streams remain to be read.
\end{defun}


\begin{defun}[Function]
echo-stream-input-stream echo-stream \\
echo-stream-output-stream echo-stream

The argument must be of type \cdf{echo-stream}.
The function \cdf{echo-stream-input-stream} returns the constituent
input stream; \cdf{echo-stream-output-stream} returns the constituent
output stream.
\end{defun}


\begin{defun}[Function]
synonym-stream-symbol synonym-stream

The argument must be of type \cdf{synonym-stream}.  This function returns
the symbol for whose value the \emph{synonym-stream} is a synonym.
\end{defun}

\begin{defun}[Function]
two-way-stream-input-stream two-way-stream \\
two-way-stream-output-stream two-way-stream

The argument must be of type \cdf{two-way-stream}.
The function \cdf{two-way-stream-input-stream} returns the constituent
input stream; \cdf{two-way-stream-output-stream} returns the constituent
output stream.
\end{defun}

\begin{defun}[Function]
interactive-stream-p stream

X3J13 voted in June 1989 \issue{STREAM-CAPABILITIES} to add the
predicate \cdf{interactive-stream-p}, which returns \cdf{t}
if the \emph{stream\/} is interactive and otherwise returns \cdf{nil}.
A \cd{type-error} error is signalled if the argument is not of type \cdf{stream}.

The precise meaning of \cdf{interactive-stream-p} is implementation-dependent
and may depend on the underlying operating system.
The intent is to distinguish between interactive and batch (background,
command-file) operations.  Some characteristics that might
distinguish a stream as interactive:
\begin{itemize}
\item The stream is connected to a person (or the equivalent)
in such a way that the program can prompt for information and
expect to receive input that might depend on the prompt.
\item The program is expected to prompt for input and to support
``normal input editing protocol'' for that operating environment.
\item A call to \cdf{read-char} might hang waiting for the user to type something
rather than quickly returning a character or an end-of-file
indication.
\end{itemize}
The value of \cdf{*terminal-io*} might or might not be interactive.
\end{defun}

\begin{defun}[Function]
stream-external-format stream

X3J13 voted in June 1989 \issue{MORE-CHARACTER-PROPOSAL} to add the
function \cdf{stream-external-format}, which returns a
specifier for the implementation-recognized scheme used for
representing characters in the argument \emph{stream}.
See the \cd{:external-format} argument to \cdf{open}.
\end{defun}

%RUSSIAN
\else

\chapter{Потоки}
\label{STREAM}

Потоки является объектами, которые служат в качестве источников или получателей
данных.
Потоки символов (или символьные потоки) возвращают или принимают строковые
символы.
Бинарные потоки возвращают или принимают целые числа.
Обычное действие Common Lisp системы заключается в чтении символов из
символьного входного потока, распознавании символов как представлений Common
Lisp'овых объектов данных, вычислении каждого объекта (как формы) и выводе
результата в выходной символьный поток.

Обычно потоки соединены с файлами или интерактивными терминалами. 
Потоки, будучи Lisp'овыми объектами, служат соединителями со внешними
устройствами, с помощью которых осуществляется ввод/вывод информации.

Потоки, символьные или бинарные, могут быть только для чтения, только для
записи, или для чтения и записи.
Какие действия могут производиться над потоком зависит от того, к какому из шести
типов он принадлежит.

\section{Стандартные потоки}

В Lisp системе есть несколько переменных, значения которых является потоками,
используемыми большим количеством функций. Эти переменные и их использование
описаны ниже. По соглашению, переменные, которые содержат поток для чтения,
имеют имена заканчивающиеся на \cd{-input}, и переменные, которые содержат поток
для записи, имеют имена, заканчивающиеся на \cd{-output}.
Имена переменных, содержащих потоки и для чтения, и для записи, заканчиваются на
\cd{-io}.

\begin{defun}[Переменная]
*standard-input*

В обычном Lisp'овом цикле взаимодействия с пользователем, входные данные
читаются из \cdf{*standard-input*} (то есть, из потока, который является
значением глобальной переменной \cdf{*standard-input*}). Большинство функций,
включая \cdf{read} и \cdf{read-char}, принимают аргумент --- поток, который
по-умолчанию \cdf{*standard-input*}. 
\end{defun}

\begin{defun}[Переменная]
*standard-output*

В обычном Lisp'овом цикле взаимодействия с пользователем, выходные данные
посылаются в \cdf{*standard-output*} (то есть, в поток, который является
значением глобальной переменной \cdf{*standard-output*}). Большинство функций,
включая \cdf{print} и \cdf{write-char}, принимают аргумент -- поток, который
по-умолчанию \cdf{*standard-output*}.
\end{defun}

\begin{defun}[Переменная]
*error-output*

Значение \cdf{*error-output*} является потоком, в который должны посылаться
сообщения об ошибках. Обычно значение совпадает с \cdf{*standard-output*}, но
\cdf{*standard-output*} может быть связан с файлов и \cdf{*error-output*}
остаётся направленной на терминал или отдельный файл для сообщений об ошибках.
\end{defun}

\begin{defun}[Переменная]
*query-io*

Значение \cdf{*query-io*} является потоком, используемым, когда необходимо
получить от пользователя ответ на некоторый вопрос. Вопрос должен быть выведен в
этот поток, и ответ из него прочитан. Когда входной поток для программы может
производится из файла, вопрос <<Вы действительно хотите удалить все файлы в
вашей директории?>> никогда не должен посылаться напрямую к пользователю. И
ответ должен прийти от пользователя, а не из данных файла.
Поэтому в этих целях, вместо \cdf{*standard-input*} и \cdf{*standard-output*},
должен использоваться \cdf{*query-io*} с помощью функции \cdf{yes-or-no-p}.
\end{defun}

\begin{defun}[Переменная]
*debug-io*

Значение \cdf{*debug-io*} является потоком, используемым для интерактивной
отладки. Часто может совпадать с \cdf{*query-io*}, но это необязательно.
\end{defun}

\begin{defun}[Переменная]
*terminal-io*

Значение \cdf{*terminal-io*} является потоком, который соединён с
пользовательской консолью. Обычно, запись в этот поток выводит данные на экран,
например, а чтение из потока осуществляет чтение ввода с клавиатуры.

Когда стандартные функции, такие как \cdf{read} и \cdf{read-char} используются с
этим потоком, то происходит копирование входных данных обратно в поток
или <<эхо>>. (Способ, с помощью которого это происходит, зависит от реализации.)
\end{defun}

\begin{defun}[Переменная]
*trace-output*

Значение \cdf{*trace-output*} является потоком, в который функция \cdf{trace}
выводит информацию.
\end{defun}

Переменные \cdf{*standard-input*}, \cdf{*standard-output*},
\cdf{*error-output*},
\cdf{*trace-output*},
\cdf{*query-io*} и \cdf{*debug-io*}
первоначально связаны с потоками-синонимами, которые направляют все операции в
поток \cdf{*terminal-io*}.
(Смотрите \cdf{make-synonym-stream}.)
Таким образом все проделанные операции на этих потоках отобразятся на терминале.

\begin{new}
X3J13 voted in January 1989
\issue{STANDARD-INPUT-INITIAL-BINDING}
to replace the requirements of the preceding
paragraph with the following new requirements:

The seven standard stream variables,
\cdf{*standard-input*}, \cdf{*standard-output*}, \cdf{*query-io*},
\cdf{*debug-io*}, \cdf{*terminal-io*},
\cdf{*error-output*}, and
\cdf{*trace-output*},
are initially bound to open streams.  (These will be called
\emph{the standard initial streams}.)

The streams that are the initial values of
\cdf{*standard-input*}, \cdf{*query-io*}, \cdf{*debug-io*}, and \cdf{*terminal-io*}
must support input.

The streams that are the initial values of
\cdf{*standard-output*},
\cdf{*error-output*},
\cdf{*trace-output*}, \cdf{*query-io*}, \cdf{*debug-io*}, and \cdf{*terminal-io*}
must support output.

None of the standard initial streams (including the one to which
\cdf{*terminal-io*} is initially bound) may be a synonym, either directly
or indirectly, for any of the standard stream variables
except \cdf{*terminal-io*}.  For example, the initial value of
\cdf{*trace-output*} may be a synonym stream for \cdf{*terminal-io*}
but not a synonym stream for \cdf{*standard-output*} or \cdf{*query-io*}.
(These are examples of direct synonyms.)  As another example,
\cdf{*query-io*} may be a two-way stream or echo stream whose
input component is a synonym for \cdf{*terminal-io*},
but its input component may not be a synonym for \cdf{*standard-input*}
or \cdf{*debug-io*}.  (These are examples of indirect synonyms.)

Any or all of the standard initial streams may be direct or indirect
synonyms for one or more common implementation-dependent streams.
For example, the standard initial streams might all be synonym streams
(or two-way or echo streams whose components are synonym streams)
to a pair of hidden terminal input and output streams maintained by
the implementation.

Part of the intent of these rules is to ensure that it is always safe
to bind any standard stream variable to the value of any other
standard stream variable (that is, unworkable circularities are
avoided) without unduly restricting implementation flexibility.
\end{new}

Пользовательская программа не должна изменять значение
\cdf{*terminal-io*}. Программа, которая, например, хочет перенаправить вывод в файл,
должна изменить значение переменной \cdf{*standard-output*}. В таком случае,
сообщения об ошибках будут продолжать посылаться в \cdf{*error-output*}, а
следовательно в \cdf{*terminal-io*}, и пользователи сможет их увидеть.

\section {Создание новых потоков}

Пожалуй самые важные конструкции для создания новых потоков это то, которые
открывают файлы. Смотрите \cdf{with-open-file} и \cdf{open}.
Следующие функции создают потоки без ссылок на файловую систему.

\begin{defun}[Функция]
make-synonym-stream symbol

\cdf{make-synonym-stream} создаёт и возвращает поток-синоним.
Любые операции на новом потоке будут проделаны на потоке, являющемся значением
динамической переменной с именем \emph{symbol}.
Если значение этой переменной изменится или будет пересвязано, то поток-синоним
будет воздействовать на новый установленный поток.

The result of
\cdf{make-synonym-stream} is always a stream of type \cdf{synonym-stream}.
Note that the type of a synonym stream is \emph{always} \cdf{synonym-stream},
regardless of the type of the stream for which it is a synonym.

Результат \cdf{make-synonym-stream} всегда является потоком типа
\cdf{synonym-stream}.

Следует отметить, что тип потока-синонима \emph{всегда} \cdf{synonym-stream},
вне зависимости от того, какой тип у связанного потока.
\end{defun}

\begin{defun}[Функция]
make-broadcast-stream &rest streams

Эта функция возвращает поток, который работает только для записи. Любая выходная
информация, посланная в этот поток, будет отослана в все указанные потоки
\emph{streams}.
Множество операций, которые могут быть выполнены на новом потоке, является
пересечением множеств операций для указанных потоков. Результаты, возвращаемые
операциями над новым потоком, являются результатами возвращёнными операциями на
последнем потоке из списка \emph{streams}.
Результаты полученные в ходе выполнения функции над всеми, кроме последнего,
потоками игнорируются.
Если не было передано ни одного потока в аргументе \emph{streams}, тогда
результат является <<кусочком клоаки>>. Вся выводимая информация будет
игнорироваться.

Результат \cdf{make-broadcast-stream} всегда является потоком типа
\cdf{broadcast-stream}.
\end{defun}

\begin{defun}[Функция]
make-concatenated-stream &rest streams

Данная функция возвращает поток, который работает только для чтения.
Входная информация берётся из первого потоки из списка \emph{streams} пока
указатель не достигнет конца-файла end-of-file, затем данный поток
откладывается, и входная информация берётся из следующего, и так далее. Если
список потоков \emph{stream} был пуст, то возвращается поток без
содержимого. Любая попытка чтения будет возвращать конец-файла end-of-file. 

Результат \cdf{make-concatenated-stream} всегда является потоком типа
\cdf{concatenated-stream}.
\end{defun}

\begin{defun}[Функция]
make-two-way-stream input-stream output-stream

Данная функция возвращает поток для чтения и записи, который входную информацию
получает из \emph{input-stream} и посылает выходную информацию в
\emph{output-stream}.

Результат \cdf{make-two-way-stream} всегда является потоком типа
\cdf{two-stream-stream}.
\end{defun}

\begin{defun}[Функция]
make-echo-stream input-stream output-stream

Данная функция возвращает поток для чтения и записи, который получает входную
информацию из \emph{input-stream} и отсылает выходную в \emph{output-stream}. В
дополнение, входная информация посылается в \emph{output-stream} (эхо).

Результат \cdf{make-echo-stream} всегда является потоком типа
\cdf{echo-stream}.

\begin{new}
X3J13 voted in January 1989
\issue{PEEK-CHAR-READ-CHAR-ECHO}
to clarify the interaction of
\cdf{read-char}, \cdf{unread-char}, and \cdf{peek-char} with echo streams.
(See the descriptions of those functions for details.)

X3J13 explicitly noted that the bidirectional streams that are the initial
values of \cdf{*query-io*}, \cdf{*debug-io*}, and \cdf{*terminal-io*},
even though they may have some echoing behavior, conceptually
are not necessarily the products of calls to \cdf{make-echo-stream}
and therefore are not subject to the new rules about echoing on echo
streams.  Instead, these initial interactive streams may have
implementation-dependent echoing behavior.
\end{new}
\end{defun}

\begin{defun}[Функция]
make-string-input-stream string &optional start end

Данная функция возвращает поток для чтения.
Данный поток последовательно будет сохранять строковые символы в подстроке в
строке \emph{string} ограниченной с помощью \emph{start} и \emph{end}. После
того, как будет достигнут последний символ, поток вернёт конец-файла.

Результат \cdf{make-string-input-stream} всегда является потоком типа
\cdf{string-stream}.
\end{defun}

\begin{defun}[Функция]
make-string-output-stream &key :element-type

Данная функция возвращает поток для записи, который будет аккумулировать всю
полученную информацию в строку, которая может быть получена с помощью функции
\cdf{get-output-stream-string}.

Аргумент \cd{:element-type} указывает, какие символы могут приниматься
потоком. Если аргумент \cd{:element-type} опущен, созданный поток должен
принимать все символы.

Результатом \cdf{make-string-output-stream} всегда является поток типа
\cdf{string-stream}.
\end{defun}

\begin{defun}[Функция]
get-output-stream-string string-output-stream

Данная функция возвращает строку, для потока, возвращённого функцией
\cdf{make-string-output-stream}, которая содержит все записанную в данный поток
информацию. После этого поток сбрасывается. Таким образом каждый вызов
\cdf{get-output-stream-string} возвращает только те символы, которые были
записаны с момента предыдущего вызова этой функции (или создания потока, если
предыдущего вызова ещё не было).
\end{defun}

\begin{defmac}
with-open-stream (var stream) {declaration}* {form}*

Форма \emph{stream} вычисляется и должна вернуть поток.
Переменная \emph{var} связывается с этим потоком, и затем выполняются формы тела
как неявный \cdf{progn}. Результатом выполнения \cdf{with-open-stream} является
значение последней формы.
Поток автоматически закрывается при выходе из формы \cdf{with-open-stream}, вне
зависимости от типа выхода. Смотрите \cdf{close}.
Поток следует рассматривать, как имеющий динамическую продолжительность
видимости.

Результатом \cdf{with-open-stream} всегда является поток типа
\cdf{file-stream}.
\end{defmac}

\begin{defmac}
with-input-from-string (var string {keyword value}*)
      {declaration}* {form}*

Тело выполняется как неявный \cdf{progn} с переменной \emph{var} связанной с
потоком символов для чтения, который последовательно предоставляет символы из
значения формы \emph{string}. \cdf{with-input-from-string} возвращает результат
выполнения последней формы \emph{form} тела.

Результатом \cdf{with-input-from-stream} всегда является поток типа
\cdf{string-stream}.

В параметрах могут использоваться следующие имена:
\begin{quotation}
  \begin{flushdesc}
  \item[\cd{:index}]
    Форма после \cd{:index} должна быть \emph{местом}, в которое можно осуществить
    запись с помощью \cdf{setf}. Если форма \cdf{with-input-from-string} завершается
    нормально, то \emph{место} будет содержать позицию первого не прочитанного
    символа из строки \emph{string} (или длину строки, если все символы были
    прочитаны).
    \emph{Место} не изменяется в процессе чтения, а только во время выхода.

  \item[\cd{:start}]
    \cd{:start} принимает аргумент, указывающий позицию с которой
    необходимо начинать чтение символов из строки \emph{string}.

  \item[\cd{:end}]
    The \cd{:end} keyword takes an argument indicating, in the manner
    usual for sequence functions, the end of
    a substring of \emph{string} to be used.
    \cd{:end} принимает аргумент, указывающий на позицию на которой необходимо
    завершить чтение символов из строки \emph{string}

  \end{flushdesc}
\end{quotation}

The \cd{:start} and \cd{:index} keywords may both specify
the same variable, which is a pointer within the string to be advanced,
perhaps repeatedly by some containing loop.

Вот простой пример использования \cdf{with-input-from-string}:
\begin{lisp}
(with-input-from-string (s "Animal Crackers" :index j :start 6) \\
~~(read s)) \EV\ crackers
\end{lisp}
В качестве побочного эффекта переменная \cd{j} будет установлена в \cd{15}.

\begin{new}
X3J13 voted in January 1989
\issue{MAPPING-DESTRUCTIVE-INTERACTION}
to restrict user side effects; see section \ref{STRUCTURE-TRAVERSAL-SECTION}.
\end{new}

\cd{:start} и \cd{:index} могут оба содержать одну переменную, указывающую
позицию в строке, возможно, внутри цикла.
\end{defmac}

\begin{defmac}
with-output-to-string (var [string [(:element-type type)]])
                      {declaration}* {form}*

Можно указать \cdf{nil} вместо строки \emph{string} и использовать аргумент
\cd{:element-type} для указания, какие символы должны приниматься созданным
потоком. Если аргумент \emph{string} не указан или он \cdf{nil} и не указан
\cd{:element-type}, то созданный поток должен принимать все символы.

If \emph{string} is specified, it must be a string with a fill pointer;
the output is incrementally appended to the string (as if by use of
\cdf{vector-push-extend}).

In this way output cannot be accidentally lost.  This change makes
\cd{with-output-to-string} behave in the same way that \cdf{format} does
when given a string as its first argument.

Результатом \cdf{with-output-to-stream} всегда является поток типа
\cdf{string-stream}.

X3J13 voted in January 1989
\issue{MAPPING-DESTRUCTIVE-INTERACTION}
to restrict user side effects; see section \ref{STRUCTURE-TRAVERSAL-SECTION}.
\end{defmac}

\section {Операции над потоками}

В этом разделе описаны только те функции, которые работают со всеми
потоки. Ввод и вывод информации слегка сложнее и описаны отдельно в
главе~\ref{IO}.
Интерфейс между потоками и файловой системой описан в главе~\ref{FILES}

\begin{defun}[Функция]
streamp object

\cdf{streamp} истинен, если его аргумент является потоком, иначе ложен.
\begin{lisp}
(streamp x) \EQ\ (typep x 'stream)
\end{lisp}

\cdf{streamp} is unaffected
by whether its argument, if a stream, is open or closed.  In either case
it returns true.
\end{defun}

\begin{defun}[Функция]
open-stream-p stream

Если аргумент, который должен быть потоком, открыт, предикат истинен, иначе
ложен.

Поток всегда создаётся открытым. Он продолжает быть открытым, пока не будет
закрыт с помощью функции \cdf{close}. Макросы \cdf{with-open-stream},
\cdf{with-input-from-string}, \cdf{with-output-to-string} и \cdf{with-open-file}
автоматически закрывают созданный поток, когда управление выходит из их тел, по
сути открытость совпадает с динамической продолжительностью видимости потока. 
\end{defun}

\begin{defun}[Функция]
input-stream-p stream

Если аргумент, который должен быть потоком, может работать для чтения, предикат
истинен, иначе ложен.
\end{defun}

\begin{defun}[Функция]
output-stream-p stream

Если аргумент, который должен быть потоком, может работать для записи, предикат
истинен, иначе ложен.
\end{defun}

\begin{defun}[Функция]
stream-element-type stream

Функция возвращает спецификатор типа, который указывает на то, какие объекты
могут быть прочитаны или записаны из/в поток \emph{stream}.
Потоки созданные с помощью \cdf{open} будут иметь тип элементов, ограниченный
подмножеством \cdf{character} или \cdf{integer}. Но в принципе поток может
проводить операции используя любые Lisp'овые объекты.
\end{defun}

\begin{defun}[Функция]
close stream &key :abort

Аргумент должен быть потоком.
Функцией этот поток закрывается. После чего операции чтения и записи выполняться
над ним не могут. Однако, конечно, некоторые операции все ещё могут
выполняться. Допускается повторное закрытие уже закрытого потока.


\begin{newer}
X3J13 voted in January 1989
\issue{CLOSED-STREAM-OPERATIONS}
and revised the vote in March 1989
to specify that if \cdf{close} is called
on an open stream, the stream is closed and \cdf{t} is returned;
but if \cdf{close} is called on a closed stream, it succeeds without
error and returns an unspecified value.
(The rationale for not specifying the value returned for a closed stream
is that in some implementations closing certain streams does not really
have an effect on them---for example, closing the \cdf{*terminal-io*}
stream might not ``really'' close it---and it is not desirable to force
such implementations to keep otherwise unnecessary state.  Portable programs
will of course not rely on such behavior.)


X3J13 also voted in January 1989 to specify exactly which inquiry
functions may be applied to closed streams:
\begin{tabbing}
\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}}lll@{}}
\cdf{streamp} & \cdf{pathname-host} & \cdf{namestring} \\
\cdf{pathname} & \cdf{pathname-device} & \cdf{file-namestring} \\
\cdf{truename} & \cdf{pathname-directory} & \cdf{directory-namestring} \\
\cdf{merge-pathnames} & \cdf{pathname-name} & \cdf{host-namestring} \\
\cdf{open} & \cdf{pathname-type} & \cdf{enough-namestring} \\
\cdf{probe-file} & \cdf{pathname-version} & \cdf{directory} \\
\end{tabular*}
\end{tabbing}
See the individual descriptions of these functions for more information
on how they operate on closed streams.
\end{newer}

\begin{new}
X3J13 voted in January 1989
\issue{CLOSE-CONSTRUCTED-STREAM}
to clarify the effect of closing various
kinds of streams.  First some terminology:
\begin{itemize}
\item
A \emph{composite} stream is one that was returned by a call to
\cd{make-synonym-stream},
\cdf{make-broadcast-stream},
\cdf{make-concatenated-stream},
\cd{make-two-way-stream},
or \cd{make-echo-stream}.

\item
The \emph{constituents} of a composite stream are the streams that were given
as arguments to the function that constructed it or, in the case of
\cd{make-synonym-stream}, the stream that is the \cdf{symbol-value} of
the symbol that was given as an argument.  (The constituent of
a synonym stream may therefore vary over time.)

\item
A \emph{constructed} stream is either a composite stream or one returned
by a call to \cdf{make-string-input-stream}, \cdf{make-string-output-stream},
\cd{with-input-from-string}, or
\cdf{with-output-to-string}.
\end{itemize}

The effect of applying \cdf{close} to a constructed stream is to close
that stream only.  No input/output operations are permitted on the
constructed stream once it has been closed (though certain inquiry
functions are still permitted, as described above).

Closing a composite stream has no effect on its constituents;
any constituents that are open remain open.

If a stream created by \cdf{make-string-output-stream} is closed,
the result of then applying \cdf{get-output-stream-string} to the
stream is unspecified.
\end{new}

Если параметр \cd{:abort} не-{\false} (а по-умолчанию он {\false}), то он
указывает на ненормальное завершение использования потока. Осуществляется
попытка убрать все побочные эффекты, созданные потоком. Например, если поток
выполнял вывод в файл, который был создан вместе с потоком, тогда, если
возможно, файл удаляется и любой ранее существовавший файл не заменяется.
\end{defun}

\begin{defun}[Функция]
broadcast-stream-streams broadcast-stream

Аргумент должен быть типа \cdf{broadcast-stream}.
Функцией возвращается список потоков для записи (и открытых, и нет).
\end{defun}

\begin{defun}[Функция]
concatenated-stream-streams concatenated-stream

Аргумент должен быть типа \cdf{concatenated-stream}.
Функцией возвращается список потоков (и открытых, и нет).
Этот список отображает упорядоченное множество потоков для чтения, из которых
поток \emph{concatenated-stream} все ещё может получать данные. Поток, из
которого в данный момент читались данные, находится в начале списка.
Если потоков для чтения нет, список может быть пустым.
\end{defun}


\begin{defun}[Функция]
echo-stream-input-stream echo-stream \\
echo-stream-output-stream echo-stream

Аргумент должен быть типа \cdf{echo-stream}.
Функция \cdf{echo-stream-input-stream} возвращает список потоков для чтения.
\cdf{echo-stream-output-stream} возвращает список потоков для записи.
\end{defun}


\begin{defun}[Функция]
synonym-stream-symbol synonym-stream

Аргумент должен быть типа \cdf{synonym-stream}. Эта функция возвращает символ,
значение которого является потоком для потока-синонима \emph{synonym-stream}.
\end{defun}


\begin{defun}[Функция]
two-way-stream-input-stream two-way-stream \\
two-way-stream-output-stream two-way-stream

Аргумент должен быть типа \cdf{two-way-stream}.
Функция \cdf{two-way-stream-input-stream} возвращает список потоков для чтения. 
\cdf{two-way-stream-output-stream} возвращает список потоков для записи.
\end{defun}


\begin{defun}[Function]
interactive-stream-p stream

X3J13 voted in June 1989 \issue{STREAM-CAPABILITIES} to add the
predicate \cdf{interactive-stream-p}, which returns \cdf{t}
if the \emph{stream\/} is interactive and otherwise returns \cdf{nil}.
A \cd{type-error} error is signalled if the argument is not of type \cdf{stream}.

The precise meaning of \cdf{interactive-stream-p} is implementation-dependent
and may depend on the underlying operating system.
The intent is to distinguish between interactive and batch (background,
command-file) operations.  Some characteristics that might
distinguish a stream as interactive:
\begin{itemize}
\item The stream is connected to a person (or the equivalent)
in such a way that the program can prompt for information and
expect to receive input that might depend on the prompt.
\item The program is expected to prompt for input and to support
``normal input editing protocol'' for that operating environment.
\item A call to \cdf{read-char} might hang waiting for the user to type something
rather than quickly returning a character or an end-of-file
indication.
\end{itemize}
The value of \cdf{*terminal-io*} might or might not be interactive.
\end{defun}

\begin{defun}[Function]
stream-external-format stream

X3J13 voted in June 1989 \issue{MORE-CHARACTER-PROPOSAL} to add the
function \cdf{stream-external-format}, which returns a
specifier for the implementation-recognized scheme used for
representing characters in the argument \emph{stream}.
See the \cd{:external-format} argument to \cdf{open}.
\end{defun}

\fi